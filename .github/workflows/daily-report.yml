name: Daily Submission Report (IST) – PR Flow

on:
  schedule:
    # 00:10 IST daily (18:40 UTC previous day)
    - cron: "40 18 * * *"
  workflow_dispatch: {}

permissions:
  contents: write        # needed to commit to the PR branch
  pull-requests: write   # needed to open/update/merge PRs

jobs:
  generate-and-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all branches (ensure student refs)
        run: |
          git fetch --all --prune --tags

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies for Excel
        run: |
          python -m pip install --upgrade pip
          pip install openpyxl==3.1.5

      - name: Run daily report script
        env:
          VERBOSE: "1"
          # Optional flags you’ve used before:
          # ENFORCE_SINGLE_FILE: "1"
          # INCLUDE_MAIN_FALLBACK: "1"
          # MAIN_BRANCH_NAME: "main"
        run: |
          python scripts/daily_report.py

      # Create or update a PR with any changed report artifacts
      - name: Create / Update Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v8
        with:
          branch: automation/reports
          commit-message: "Daily IST report: add CSV/MD/XLSX"
          title: "Daily IST report"
          body: |
            Automated nightly report files.
            - Generated by GitHub Actions
            - Contains daily markdown summary, CSVs, and the Excel matrix
          labels: automated, reports
          delete-branch: true

      # Short-circuit if there were no changes (no PR created/updated)
      - name: Stop if no changes
        if: steps.cpr.outputs.pull-request-number == ''
        run: echo "No report file changes; nothing to merge."

      # Optionally set PR to auto-merge when all checks pass
      # Requires Auto-merge enabled on the repo and PR has mergeability
      - name: Enable auto-merge (squash) on the PR
        if: steps.cpr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number="${{ steps.cpr.outputs.pull-request-number }}"
          echo "Enabling auto-merge for PR #$pr_number"
          # Choose your preferred merge method: merge | squash | rebase
          gh pr merge "$pr_number" --squash --auto